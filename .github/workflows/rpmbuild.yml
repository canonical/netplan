name: RPM build

on:
  push:
    branches: [ main, 'stable/**' ]
    paths-ignore:
      - 'doc/**'
  pull_request:
    branches: [ '**' ]
    paths-ignore:
      - 'doc/**'

jobs:
  rpm:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        container:
          - fedora:rawhide
          - fedora:latest
          - almalinux:10-kitten
          - almalinux:10
          # - almalinux:9  # lacking meson >= 1.3.0
    container:
      image: ${{ matrix.container }}
    steps:
      - name: Runner setup
        run: |
          cat /etc/os-release
          dnf -y install gzip sudo rpmdevtools

      - uses: actions/checkout@v4
      - name: Build & Test
        run: |
          dnf -y install epel-release || true
          crb enable || true                            # Meson/CMocka on EL10
          dnf -y builddep rpm/netplan.spec
          adduser test
          chown -R test:test .
          sudo -u test rpmbuild -bi -D "debug_package %{nil}" --build-in-place rpm/netplan.spec
